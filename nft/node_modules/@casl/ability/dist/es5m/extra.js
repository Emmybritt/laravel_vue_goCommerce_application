import{buildOr as r,buildAnd as n}from"@ucast/mongo2js";function t(r){return Array.isArray(r)?r:[r]}function e(r,n,t){var e=r;var u=n;if(-1!==n.indexOf(".")){var i=n.split(".");u=i.pop();e=i.reduce((function(r,n){r[n]=r[n]||{};return r[n]}),r)}e[u]=t}function u(r,n,t,e){var u={};var i=r.rulesFor(n,t);for(var o=0;o<i.length;o++){var a=i[o];var f=a.inverted?"$and":"$or";if(!a.conditions)if(a.inverted)break;else{delete u[f];return u}else{u[f]=u[f]||[];u[f].push(e(a))}}return u.$or?u:null}function i(r){if(!r.ast)throw new Error('Ability rule "'+JSON.stringify(r)+'" does not have "ast" property. So, cannot be used to generate AST');return r.ast}function o(t,e,o){var a=u(t,e,o,i);if(null===a)return null;if(!a.$and)return a.$or?r(a.$or):n([]);if(a.$or)a.$and.push(r(a.$or));return n(a.$and)}function a(r,n,t){return r.rulesFor(n,t).reduce((function(r,n){if(n.inverted||!n.conditions)return r;return Object.keys(n.conditions).reduce((function(r,t){var u=n.conditions[t];if(!u||u.constructor!==Object)e(r,t,u);return r}),r)}),{})}function f(r,n,t,e){var u=r.detectSubjectType(t);var i=r.possibleRulesFor(n,u);var o=new Set;var a=o.delete.bind(o);var f=o.add.bind(o);var v=i.length;while(v--){var c=i[v];if(c.matchesConditions(t)){var l=c.inverted?a:f;e.fieldsFrom(c).forEach(l)}}return Array.from(o)}var v=function r(n){return Array.isArray(n)?n.join(","):n};function c(r,n){return r.map((function(r){var e=[v(r.action||r.actions),"function"===typeof n?t(r.subject).map(n).join(","):v(r.subject),r.conditions||0,r.inverted?1:0,r.fields?v(r.fields):0,r.reason||""];while(!e[e.length-1])e.pop();return e}))}function l(r,n){return r.map((function(r){var t=r[0],e=r[1],u=r[2],i=r[3],o=r[4],a=r[5];var f=e.split(",");var v={inverted:!!i,action:t.split(","),subject:"function"===typeof n?f.map(n):f};if(u)v.conditions=u;if(o)v.fields=o.split(",");if(a)v.reason=a;return v}))}export{c as packRules,f as permittedFieldsOf,o as rulesToAST,a as rulesToFields,u as rulesToQuery,l as unpackRules};
//# sourceMappingURL=extra.js.map
